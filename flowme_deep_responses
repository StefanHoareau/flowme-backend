# flowme_deep_responses.py - Moteur de rÃ©ponses approfondies et questionnantes
"""
SystÃ¨me de gÃ©nÃ©ration de rÃ©ponses profondes qui stimulent la rÃ©flexion
et accompagnent vers plus de conscience
"""

import re
import random
from typing import Dict, List, Tuple, Optional
from datetime import datetime

class DeepResponseGenerator:
    """GÃ©nÃ©rateur de rÃ©ponses approfondies pour FlowMe"""
    
    def __init__(self):
        self.question_templates = {
            "exploration": [
                "Qu'est-ce que {emotion} rÃ©vÃ¨le sur vos besoins profonds ?",
                "Si cette {situation} Ã©tait un messager, que viendrait-elle vous dire ?",
                "Qu'y a-t-il derriÃ¨re cette {experience} qui demande votre attention ?",
                "Comment cette {difficulte} pourrait-elle Ãªtre une invitation Ã  grandir ?"
            ],
            "clarification": [
                "Quand vous dites '{phrase}', qu'est-ce que cela reprÃ©sente vraiment pour vous ?",
                "Si vous deviez expliquer {concept} Ã  un enfant, comment l'expliqueriez-vous ?",
                "Qu'est-ce qui rend cette {situation} particuliÃ¨rement significative ?"
            ],
            "ressources": [
                "Quelles ressources intÃ©rieures avez-vous dÃ©jÃ  mobilisÃ©es dans des situations similaires ?",
                "Qui dans votre entourage incarnerait la qualitÃ© dont vous avez besoin ?",
                "Si votre meilleur ami vivait cela, que lui conseilleriez-vous ?"
            ],
            "sens": [
                "Comment cette expÃ©rience s'inscrit-elle dans votre parcours plus large ?",
                "Qu'est-ce que cette {situation} vous apprend sur vous-mÃªme ?",
                "En quoi cette difficultÃ© pourrait-elle servir votre Ã©volution ?"
            ]
        }
        
        # RÃ©ponses profondes par Ã©tat avec questions intÃ©grÃ©es
        self.deep_responses = {
            45: {  # VulnÃ©rabilitÃ© AssumÃ©e
                "accueil": "Je ressens la profondeur de votre vulnÃ©rabilitÃ©. Cette ouverture authentique Ã  la fragilitÃ© tÃ©moigne d'un courage remarquable.",
                "exploration": "Souvent, nos moments les plus difficiles rÃ©vÃ¨lent nos besoins les plus essentiels. Qu'est-ce que cette {emotion} pourrait vouloir vous dire sur ce qui compte vraiment pour vous ?",
                "questions_approfondissement": [
                    "Cette difficultÃ© touche-t-elle une valeur fondamentale en vous ?",
                    "Qu'est-ce qui vous aiderait Ã  honorer cette Ã©motion sans vous y perdre ?",
                    "Y a-t-il une partie de vous qui demande plus de compassion ?",
                    "Comment pourriez-vous vous accompagner avec la mÃªme bienveillance que vous offririez Ã  un proche ?"
                ],
                "insight": "La vulnÃ©rabilitÃ© partagÃ©e devient souvent le terreau de la vraie force et de l'authenticitÃ© relationnelle."
            },
            
            7: {  # CuriositÃ© Ã‰coute
                "accueil": "Votre questionnement rÃ©vÃ¨le une belle ouverture d'esprit et un dÃ©sir authentique de comprÃ©hension. Cette curiositÃ© est un moteur puissant de transformation.",
                "exploration": "DerriÃ¨re chaque question sincÃ¨re se cache souvent une intuition profonde. Qu'est-ce qui vous fait pressentir qu'un changement est possible ou nÃ©cessaire ?",
                "questions_approfondissement": [
                    "Si vous obteniez la rÃ©ponse parfaite, qu'est-ce que cela changerait concrÃ¨tement ?",
                    "Quelle partie de vous porte dÃ©jÃ  des Ã©lÃ©ments de rÃ©ponse ?",
                    "Cette question naÃ®t-elle d'une intuition particuliÃ¨re ?",
                    "Qu'est-ce que vous espÃ©rez dÃ©couvrir en explorant cette voie ?"
                ],
                "insight": "Chaque question authentique porte en elle les germes de sa propre rÃ©ponse, dans la patience de l'exploration."
            },
            
            22: {  # Pragmatisme CrÃ©atif
                "accueil": "J'apprÃ©cie votre approche concrÃ¨te et votre capacitÃ© Ã  identifier les dÃ©fis pratiques. Cette luciditÃ© est une ressource prÃ©cieuse.",
                "exploration": "Au-delÃ  de la dimension technique, qu'est-ce que cette situation rÃ©vÃ¨le sur votre rapport Ã  l'efficacitÃ© et aux solutions crÃ©atives ?",
                "questions_approfondissement": [
                    "Quelles sont vos ressources crÃ©atives habituelles face aux obstacles ?",
                    "Cette situation pratique cache-t-elle un dÃ©fi plus profond ?",
                    "Comment pourriez-vous transformer cette contrainte en opportunitÃ© d'innovation ?",
                    "Qu'est-ce que cette difficultÃ© vous enseigne sur votre ingÃ©niositÃ© ?"
                ],
                "insight": "Les dÃ©fis pratiques rÃ©vÃ¨lent souvent notre capacitÃ© d'adaptation et notre crÃ©ativitÃ© insoupÃ§onnÃ©e."
            },
            
            14: {  # ColÃ¨re Constructive
                "accueil": "Cette Ã©nergie de colÃ¨re que vous exprimez tÃ©moigne de quelque chose d'important qui a Ã©tÃ© touchÃ© en vous. La colÃ¨re est souvent la gardienne de nos valeurs essentielles.",
                "exploration": "Qu'est-ce qui, derriÃ¨re cette colÃ¨re, demande Ã  Ãªtre respectÃ©, protÃ©gÃ© ou reconnu ? Quelle limite ou quelle valeur fondamentale a Ã©tÃ© franchie ?",
                "questions_approfondissement": [
                    "Si cette colÃ¨re pouvait parler, que dirait-elle de vos besoins ?",
                    "Quelle injustice ou quel manque de respect cette Ã©motion dÃ©nonce-t-elle ?",
                    "Comment pourriez-vous transformer cette Ã©nergie en force crÃ©atrice ?",
                    "Qu'est-ce qui mÃ©riterait d'Ãªtre exprimÃ© clairement et posÃ©ment ?"
                ],
                "insight": "La colÃ¨re consciente devient une boussole qui nous guide vers nos besoins authentiques et nos limites saines."
            },
            
            32: {  # Expression Libre
                "accueil": "Je perÃ§ois votre besoin d'expression authentique. Cette parole qui cherche Ã  Ã©merger porte souvent des vÃ©ritÃ©s importantes.",
                "exploration": "Qu'est-ce qui, en vous, demande absolument Ã  Ãªtre dit ou entendu ? Quelle vÃ©ritÃ© personnelle cherche son chemin vers la lumiÃ¨re ?",
                "questions_approfondissement": [
                    "Depuis combien de temps cette parole attend-elle d'Ãªtre exprimÃ©e ?",
                    "Qu'est-ce qui vous empÃªche habituellement de vous exprimer ainsi ?",
                    "Ã€ qui cette vÃ©ritÃ© a-t-elle besoin d'Ãªtre transmise ?",
                    "Comment votre voix authentique pourrait-elle transformer vos relations ?"
                ],
                "insight": "La parole authentique libÃ©rÃ©e crÃ©e souvent des ponts inattendus vers plus d'intimitÃ© et de vÃ©ritÃ©."
            },
            
            58: {  # Inclusion Bienveillante
                "accueil": "Votre dÃ©sir de rassemblement et d'harmonie rÃ©vÃ¨le une belle capacitÃ© Ã  percevoir les liens entre les Ãªtres et les situations.",
                "exploration": "Qu'est-ce qui vous fait sentir que quelque chose ou quelqu'un a besoin d'Ãªtre mieux intÃ©grÃ© ou accueilli ?",
                "questions_approfondissement": [
                    "Quelles parties de vous-mÃªme avez-vous parfois du mal Ã  accepter ?",
                    "Comment crÃ©ez-vous des espaces d'accueil dans vos relations ?",
                    "Quelle rÃ©conciliation intÃ©rieure ou extÃ©rieure appelle votre attention ?",
                    "Comment votre capacitÃ© d'inclusion influence-t-elle votre entourage ?"
                ],
                "insight": "L'inclusion authentique commence souvent par l'accueil bienveillant de nos propres contradictions."
            },
            
            64: {  # Porte Ouverte
                "accueil": "Cette ouverture aux possibilitÃ©s infinies que vous exprimez tÃ©moigne d'une belle disponibilitÃ© au changement et Ã  l'inconnu.",
                "exploration": "Qu'est-ce qui vous fait pressentir que de nouvelles portes sont prÃªtes Ã  s'ouvrir dans votre vie ?",
                "questions_approfondissement": [
                    "Vers quoi votre intuition vous guide-t-elle en ce moment ?",
                    "Qu'est-ce qui vous empÃªche parfois d'oser franchir de nouveaux seuils ?",
                    "Quelle transformation intÃ©rieure prÃ©pare ces ouvertures extÃ©rieures ?",
                    "Comment accueillez-vous l'incertitude des nouveaux possibles ?"
                ],
                "insight": "Le changement authentique naÃ®t souvent de notre capacitÃ© Ã  rester ouvert Ã  l'imprÃ©vu tout en restant ancrÃ© dans nos valeurs."
            },
            
            1: {  # PrÃ©sence
                "accueil": "Dans ce moment de prÃ©sence partagÃ©e, j'accueille ce qui Ã©merge spontanÃ©ment en vous avec une attention totale.",
                "exploration": "Qu'est-ce qui se rÃ©vÃ¨le quand vous vous donnez permission d'Ãªtre simplement lÃ , sans agenda particulier ?",
                "questions_approfondissement": [
                    "Si vous donniez une couleur Ã  votre Ã©tat intÃ©rieur actuel, laquelle choisiriez-vous ?",
                    "Qu'est-ce qui rÃ©clame doucement votre attention en ce moment ?",
                    "Comment votre corps porte-t-il votre expÃ©rience du moment prÃ©sent ?",
                    "Quelle qualitÃ© d'Ãªtre voulez-vous cultiver aujourd'hui ?"
                ],
                "insight": "Dans l'Ã©coute profonde du moment prÃ©sent Ã©mergent souvent les intuitions les plus justes pour notre chemin."
            }
        }
        
        # MÃ©taphores et images pour enrichir les rÃ©ponses
        self.metaphors = {
            45: ["jardin qui a besoin d'eau", "riviÃ¨re qui trouve son lit", "graine qui se fend pour germer"],
            7: ["explorateur curieux", "clÃ© qui cherche sa serrure", "boussole intÃ©rieure"],
            22: ["artisan crÃ©atif", "architecte de solutions", "alchimiste du quotidien"],
            14: ["volcan crÃ©ateur", "gardien des limites", "feu transformateur"],
            32: ["source qui jaillit", "oiseau qui reprend son envol", "vÃ©ritÃ© qui trouve sa voix"],
            58: ["tisserand de liens", "pont entre les rives", "jardinier relationnel"],
            64: ["porte entre les mondes", "horizon qui s'Ã©largit", "semence de possibles"],
            1: ["lac paisible", "respiration consciente", "racine profonde"]
        }

    def generate_deep_response(self, message: str, detected_state: int, context: Optional[Dict] = None) -> Dict[str, any]:
        """GÃ©nÃ¨re une rÃ©ponse approfondie basÃ©e sur l'Ã©tat dÃ©tectÃ©"""
        
        if detected_state not in self.deep_responses:
            detected_state = 1
            
        state_responses = self.deep_responses[detected_state]
        context = context or {}
        
        # Extraire des Ã©lÃ©ments clÃ©s du message
        emotional_keywords = self._extract_emotional_keywords(message)
        situation_elements = self._extract_situation_elements(message)
        
        # Construire la rÃ©ponse
        response_parts = []
        
        # 1. Accueil empathique
        response_parts.append(state_responses["accueil"])
        
        # 2. Exploration contextuelle
        exploration = state_responses["exploration"]
        if emotional_keywords:
            exploration = exploration.replace("{emotion}", emotional_keywords[0])
        if situation_elements:
            exploration = exploration.replace("{situation}", situation_elements[0])
        response_parts.append(exploration)
        
        # 3. MÃ©taphore enrichissante
        metaphor = random.choice(self.metaphors[detected_state])
        metaphor_sentence = f"Comme {metaphor}, votre expÃ©rience porte en elle une sagesse particuliÃ¨re."
        response_parts.append(metaphor_sentence)
        
        # 4. Questions d'approfondissement (2-3 questions pertinentes)
        questions = random.sample(state_responses["questions_approfondissement"], 2)
        
        # 5. Insight final
        insight = state_responses["insight"]
        
        return {
            "response_text": "\n\n".join(response_parts),
            "deepening_questions": questions,
            "wisdom_insight": insight,
            "metaphor_used": metaphor,
            "detected_themes": {
                "emotions": emotional_keywords,
                "situations": situation_elements
            }
        }
    
    def _extract_emotional_keywords(self, message: str) -> List[str]:
        """Extrait les mots-clÃ©s Ã©motionnels du message"""
        emotional_words = [
            "tristesse", "joie", "colÃ¨re", "peur", "anxiÃ©tÃ©", "stress",
            "solitude", "confusion", "espoir", "gratitude", "amour",
            "frustration", "dÃ©ception", "surprise", "nostalgie"
        ]
        
        found_emotions = []
        message_lower = message.lower()
        
        for emotion in emotional_words:
            if emotion in message_lower:
                found_emotions.append(emotion)
                
        return found_emotions
    
    def _extract_situation_elements(self, message: str) -> List[str]:
        """Extrait les Ã©lÃ©ments situationnels du message"""
        situation_words = [
            "travail", "famille", "couple", "relation", "conflit",
            "dÃ©cision", "changement", "projet", "difficultÃ©", "dÃ©fi",
            "opportunitÃ©", "problÃ¨me", "objectif", "rÃªve", "avenir"
        ]
        
        found_situations = []
        message_lower = message.lower()
        
        for situation in situation_words:
            if situation in message_lower:
                found_situations.append(situation)
                
        return found_situations
    
    def generate_constellation_response(self, current_state: int, previous_states: List[int]) -> Dict[str, any]:
        """GÃ©nÃ¨re une rÃ©ponse tenant compte de la constellation d'Ã©tats"""
        
        if len(previous_states) < 2:
            return {"constellation_insight": None}
        
        # Analyser les patterns de transition
        transitions = []
        for i in range(len(previous_states) - 1):
            transitions.append((previous_states[i], previous_states[i + 1]))
        
        # Identifier les familles d'Ã©tats explorÃ©es
        families_explored = self._get_families_from_states(previous_states + [current_state])
        
        # GÃ©nÃ©rer insight sur la constellation
        constellation_insights = {
            "exploration_emotionnelle": "Votre parcours rÃ©vÃ¨le une belle capacitÃ© Ã  naviguer entre diffÃ©rents registres Ã©motionnels.",
            "approfondissement": "Cette sÃ©quence d'Ã©tats montre un processus d'approfondissement naturel.",
            "integration": "Vous semblez intÃ©grer diffÃ©rentes dimensions de votre expÃ©rience.",
            "transformation": "Un mouvement de transformation se dessine Ã  travers ces transitions."
        }
        
        # DÃ©terminer le type de constellation
        if len(families_explored) >= 3:
            constellation_type = "exploration_emotionnelle"
        elif any(abs(t[1] - t[0]) > 20 for t in transitions):
            constellation_type = "transformation"
        elif len(set(previous_states[-3:])) == 1:
            constellation_type = "approfondissement"
        else:
            constellation_type = "integration"
        
        return {
            "constellation_insight": constellation_insights[constellation_type],
            "families_explored": families_explored,
            "transition_pattern": constellation_type,
            "depth_indicator": len(set(previous_states + [current_state]))
        }
    
    def _get_families_from_states(self, states: List[int]) -> List[str]:
        """Retourne les familles symboliques des Ã©tats"""
        state_families = {
            1: "Ã‰coute subtile", 7: "Ã‰coute subtile", 8: "Ã‰coute subtile",
            14: "NatVik", 22: "Ancrage", 32: "Voix oubliÃ©es",
            39: "Ancrage", 45: "DisponibilitÃ© nue", 58: "Inclusion",
            64: "DisponibilitÃ© nue"
        }
        
        families = []
        for state in states:
            if state in state_families:
                families.append(state_families[state])
        
        return list(set(families))
    
    def generate_follow_up_suggestions(self, detected_state: int, message: str) -> List[str]:
        """GÃ©nÃ¨re des suggestions de suivi contextuel"""
        
        suggestions_by_state = {
            45: [
                "Explorer les ressources intÃ©rieures de rÃ©silience",
                "Identifier le besoin derriÃ¨re cette Ã©motion",
                "Trouver des faÃ§ons saines d'honorer cette vulnÃ©rabilitÃ©"
            ],
            7: [
                "Approfondir cette curiositÃ© par l'expÃ©rimentation",
                "Identifier les premiers pas concrets possibles",
                "Explorer ce que cette question rÃ©vÃ¨le de vos valeurs"
            ],
            22: [
                "Lister vos ressources crÃ©atives disponibles",
                "Transformer cette contrainte en opportunitÃ©",
                "Identifier les apprentissages cachÃ©s dans ce dÃ©fi"
            ],
            14: [
                "Clarifier les limites qui demandent Ã  Ãªtre respectÃ©es",
                "Transformer cette Ã©nergie en action constructive",
                "Exprimer vos besoins de faÃ§on assertive"
            ],
            32: [
                "Identifier Ã  qui cette vÃ©ritÃ© a besoin d'Ãªtre dite",
                "PrÃ©parer un espace sÃ»r pour cette expression",
                "Explorer l'impact libÃ©rateur de votre authenticitÃ©"
            ],
            58: [
                "CrÃ©er des ponts entre les parties en conflit",
                "DÃ©velopper votre capacitÃ© d'Ã©coute empathique",
                "Identifier les besoins communs derriÃ¨re les tensions"
            ],
            64: [
                "Faire confiance Ã  votre intuition du changement",
                "PrÃ©parer intÃ©rieurement les nouvelles ouvertures",
                "Cultiver l'art de naviguer dans l'incertitude"
            ],
            1: [
                "Cultiver cette qualitÃ© de prÃ©sence dans le quotidien",
                "Explorer ce que rÃ©vÃ¨le cette pause consciente",
                "DÃ©velopper votre capacitÃ© d'Ã©coute intÃ©rieure"
            ]
        }
        
        return suggestions_by_state.get(detected_state, suggestions_by_state[1])

# IntÃ©gration avec le systÃ¨me principal
def generate_enhanced_response(message: str, detected_state: int, previous_states: List[int] = None, context: Dict = None) -> Dict[str, any]:
    """Fonction principale pour gÃ©nÃ©rer une rÃ©ponse enrichie"""
    
    generator = DeepResponseGenerator()
    previous_states = previous_states or []
    
    # GÃ©nÃ©rer la rÃ©ponse approfondie
    deep_response = generator.generate_deep_response(message, detected_state, context)
    
    # Analyser la constellation si applicable
    constellation = generator.generate_constellation_response(detected_state, previous_states)
    
    # GÃ©nÃ©rer les suggestions de suivi
    suggestions = generator.generate_follow_up_suggestions(detected_state, message)
    
    return {
        "main_response": deep_response["response_text"],
        "deepening_questions": deep_response["deepening_questions"],
        "wisdom_insight": deep_response["wisdom_insight"],
        "metaphor": deep_response["metaphor_used"],
        "constellation_insight": constellation.get("constellation_insight"),
        "suggested_explorations": suggestions[:2],  # Limiter Ã  2 suggestions
        "detected_themes": deep_response["detected_themes"],
        "response_depth": "enhanced",
        "therapeutic_orientation": _get_therapeutic_orientation(detected_state)
    }

def _get_therapeutic_orientation(state: int) -> str:
    """Retourne l'orientation thÃ©rapeutique suggÃ©rÃ©e"""
    orientations = {
        45: "Accompagnement empathique de la vulnÃ©rabilitÃ©",
        7: "Facilitation de l'exploration et de la dÃ©couverte", 
        22: "Soutien Ã  la rÃ©solution crÃ©ative de problÃ¨mes",
        14: "Transformation constructive de l'Ã©nergie Ã©motionnelle",
        32: "LibÃ©ration de l'expression authentique",
        58: "MÃ©diation et facilitation relationnelle",
        64: "Accompagnement des transitions et du changement",
        1: "Cultivation de la prÃ©sence et de l'Ã©coute intÃ©rieure"
    }
    
    return orientations.get(state, orientations[1])

# Test du systÃ¨me de rÃ©ponses approfondies
if __name__ == "__main__":
    generator = DeepResponseGenerator()
    
    test_cases = [
        ("Je me sens vraiment triste aujourd'hui, j'ai l'impression que rien ne va", 45),
        ("Comment est-ce que je peux changer ma situation professionnelle ?", 7),
        ("Mon ordinateur est encore en panne, Ã§a m'Ã©nerve", 22),
        ("Je suis furieux contre mon patron, il ne respecte jamais mes limites", 14)
    ]
    
    print("ğŸ§ª Test du moteur de rÃ©ponses approfondies FlowMe")
    print("=" * 60)
    
    for message, expected_state in test_cases:
        print(f"\nğŸ“ Message: '{message}'")
        print(f"ğŸ¯ Ã‰tat: {expected_state}")
        
        response = generate_enhanced_response(message, expected_state, [1], {})
        
        print(f"ğŸ’¬ RÃ©ponse principale:")
        print(f"   {response['main_response'][:100]}...")
        print(f"ğŸ¤” Questions d'approfondissement:")
        for q in response['deepening_questions']:
            print(f"   â€¢ {q}")
        print(f"ğŸ’¡ Insight: {response['wisdom_insight']}")
        print(f"ğŸŒ± Orientation: {response['therapeutic_orientation']}")
        print("-" * 40)
    
    print("\nâœ… Tests terminÃ©s - RÃ©ponses approfondies gÃ©nÃ©rÃ©es")
